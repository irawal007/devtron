<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devtron Audit Dashboard</title>
    <style>
        body { font-family: sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
        .filter-container { margin-bottom: 10px; }
        .export-btn { margin-bottom: 10px; }
        #query-container { margin-top: 20px; }
        #query-input { width: 100%; height: 100px; }
        .warning { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Devtron Audit Dashboard</h1>

    <!-- User Management Section -->
    <h2>User Management</h2>
    <div class="filter-container">
        <input type="text" id="email-filter" placeholder="Filter by email...">
        <input type="text" id="team-filter" placeholder="Filter by team...">
    </div>
    <button class="export-btn" onclick="exportData('/api/users/export')">Export Users to CSV</button>
    <table id="users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Team</th>
                <th>Active</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Deployment Analytics Section -->
    <h2>Deployment Analytics</h2>
    <button class="export-btn" onclick="exportData('/api/deployments/export')">Export Deployments to CSV</button>
    <table id="deployments-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>App Name</th>
                <th>Environment</th>
                <th>Status</th>
                <th>Started On</th>
                <th>Finished On</th>
                <th>Triggered By</th>
                <th>Image</th>
                <th>Workflow Type</th>
                <th>Image Digest</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Monthly Deployment History Export -->
    <h2>Monthly Deployment History Export</h2>
    <div>
        <input type="number" id="month-input" placeholder="Month (1-12)" min="1" max="12">
        <input type="number" id="year-input" placeholder="Year (e.g., 2023)">
        <button onclick="exportMonthlyDeployments()">Export Monthly Deployments</button>
    </div>


    <!-- Application Insights Section -->
    <h2>Application Insights</h2>
    <button class="export-btn" onclick="exportData('/api/applications/export')">Export Applications to CSV</button>
    <table id="applications-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>App Name</th>
                <th>Version History</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- System Auditing Section -->
    <h2>System Auditing</h2>
    <table id="audits-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>User Email</th>
                <th>Client IP</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- "Who Triggered What and When" Report -->
    <h2>"Who Triggered What and When" Report</h2>
    <table id="trigger-audits-table">
        <thead>
            <tr>
                <th>Triggered By</th>
                <th>App Name</th>
                <th>Pipeline</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <!-- Virtual Service Usage Report -->
    <h2>Virtual Service Usage Report</h2>
    <table id="virtual-service-usage-table">
        <thead>
            <tr>
                <th>App ID</th>
                <th>App Name</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Apps Not Deployed Report -->
    <h2>Apps Not Deployed in Specific Environments</h2>
    <div>
        <input type="text" id="not-deployed-env-ids" placeholder="Enter comma-separated env IDs">
        <button onclick="getAppsNotDeployed()">Get Apps</button>
    </div>
    <table id="not-deployed-table">
        <thead>
            <tr>
                <th>App ID</th>
                <th>App Name</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Build Time Analytics -->
    <h2>Build Time Analytics</h2>
    <div>
        <input type="text" id="build-time-app-id" placeholder="Enter App ID (optional)">
        <button onclick="getBuildTimeAnalytics()">Get Build Times</button>
    </div>
    <table id="build-time-table">
        <thead>
            <tr>
                <th>App Name</th>
                <th>Pipeline ID</th>
                <th>Build Time (seconds)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Chart Version Usage Report -->
    <h2>Chart Version Usage Report</h2>
    <div>
        <input type="text" id="chart-version-input" placeholder="Enter Chart Version">
        <button onclick="getChartVersionUsage()">Get Apps</button>
    </div>
    <table id="chart-version-usage-table">
        <thead>
            <tr>
                <th>App ID</th>
                <th>App Name</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Scoped Variable Usage Report -->
    <h2>Scoped Variable Usage Report</h2>
    <div>
        <input type="text" id="scoped-variable-input" placeholder="Enter Variable Name">
        <button onclick="getScopedVariableUsage()">Get Usage</button>
    </div>
    <table id="scoped-variable-usage-table">
        <thead>
            <tr>
                <th>Entity Type</th>
                <th>Entity ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Deployed Branch Report -->
    <h2>Deployed Branch Report</h2>
    <div>
        <input type="text" id="deployed-branch-env-id" placeholder="Enter Environment ID">
        <button onclick="getDeployedBranchReport()">Get Deployed Branches</button>
    </div>
    <table id="deployed-branch-table">
        <thead>
            <tr>
                <th>App Name</th>
                <th>Branch</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Image Scanning Not Enabled Report -->
    <h2>Image Scanning Not Enabled Report</h2>
    <table id="no-image-scan-table">
        <thead>
            <tr>
                <th>Pipeline ID</th>
                <th>App Name</th>
                <th>Pipeline Name</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Trivy Scan Result Download -->
    <h2>Trivy Scan Result Download</h2>
    <div>
        <input type="text" id="trivy-app-id" placeholder="Enter App ID">
        <button onclick="downloadTrivyScanResult()">Download CSV</button>
    </div>

    <!-- Secrets and ConfigMaps Dump -->
    <h2>Secrets and ConfigMaps Dump</h2>
    <div>
        <input type="text" id="dump-cluster-id" placeholder="Enter Cluster ID">
        <button onclick="dumpSecretsAndConfigMaps()">Get Dump</button>
    </div>
    <table id="dump-table">
        <thead>
            <tr>
                <th>App Name</th>
                <th>Environment</th>
                <th>ConfigMap</th>
                <th>Secret</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>


    <!-- Simple SQL Query Interface Section -->
    <h2>Simple SQL Query Interface</h2>
    <div id="query-container">
        <p class="warning">Warning: Use this interface with caution. Only read-only queries are allowed.</p>
        <textarea id="query-input" placeholder="Enter your SQL query here..."></textarea>
        <button id="execute-query-btn">Execute Query</button>
        <h3>Query Results</h3>
        <table id="query-results-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>


    <script>
        // Common function to export data by navigating to the export URL.
        function exportData(url) {
            window.location.href = url;
        }

        function exportMonthlyDeployments() {
            const month = document.getElementById('month-input').value;
            const year = document.getElementById('year-input').value;
            if (!month || !year) {
                alert('Please enter both month and year.');
                return;
            }
            window.location.href = `/api/deployments/export/monthly?month=${month}&year=${year}`;
        }

        // Fetches and renders data for a given API endpoint and table.
        async function fetchAndRender(apiUrl, tableId, columns, customRender) {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                const tableBody = document.querySelector(`#${tableId} tbody`);
                if (customRender) {
                    customRender(tableBody, data);
                } else {
                    renderTable(tableBody, data, columns);
                }
            } catch (error) {
                console.error(`Failed to fetch data from ${apiUrl}:`, error);
            }
        }

        // Generic function to render data in a table.
        function renderTable(tableBody, data, columns) {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${columns.length}">No data found.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const cell = document.createElement('td');
                    cell.textContent = Array.isArray(item[col]) ? item[col].join(', ') : item[col];
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        // Custom renderer for the applications table.
        function renderApplications(tableBody, applications) {
            tableBody.innerHTML = '';
            if (!applications || applications.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No applications found.</td></tr>';
                return;
            }
            applications.forEach(app => {
                const row = document.createElement('tr');
                const versionHistory = app.versionHistory.map(v => `ID: ${v.installedAppVersionId}, Status: ${v.status}`).join('<br>');
                row.innerHTML = `
                    <td>${app.id}</td>
                    <td>${app.appName}</td>
                    <td>${versionHistory}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Apps not deployed report
        function getAppsNotDeployed() {
            const envIds = document.getElementById('not-deployed-env-ids').value;
            if (!envIds) {
                alert('Please enter environment IDs.');
                return;
            }
            fetchAndRender(`/api/applications/not-deployed?envIds=${envIds}`, 'not-deployed-table', ['id', 'name']);
        }

        // Build time analytics
        function getBuildTimeAnalytics() {
            const appId = document.getElementById('build-time-app-id').value;
            let url = '/api/ci/build-time';
            if (appId) {
                url += `?appId=${appId}`;
            }
            fetchAndRender(url, 'build-time-table', ['appName', 'pipelineId', 'buildTime']);
        }

        // Chart version usage report
        function getChartVersionUsage() {
            const chartVersion = document.getElementById('chart-version-input').value;
            if (!chartVersion) {
                alert('Please enter a chart version.');
                return;
            }
            fetchAndRender(`/api/applications/chart-version-usage?chartVersion=${chartVersion}`, 'chart-version-usage-table', ['id', 'name']);
        }

        // Scoped variable usage report
        function getScopedVariableUsage() {
            const variableName = document.getElementById('scoped-variable-input').value;
            if (!variableName) {
                alert('Please enter a variable name.');
                return;
            }
            fetchAndRender(`/api/scoped-variable-usage?variableName=${variableName}`, 'scoped-variable-usage-table', ['entityType', 'entityId']);
        }

        // Deployed branch report
        function getDeployedBranchReport() {
            const envId = document.getElementById('deployed-branch-env-id').value;
            if (!envId) {
                alert('Please enter an environment ID.');
                return;
            }
            fetchAndRender(`/api/applications/deployed-branch?envId=${envId}`, 'deployed-branch-table', ['appName', 'branch']);
        }

        // Trivy scan result download
        function downloadTrivyScanResult() {
            const appId = document.getElementById('trivy-app-id').value;
            if (!appId) {
                alert('Please enter an App ID.');
                return;
            }
            window.location.href = `/api/applications/trivy-scan/export?appId=${appId}`;
        }

        // Secrets and ConfigMaps Dump
        function dumpSecretsAndConfigMaps() {
            const clusterId = document.getElementById('dump-cluster-id').value;
            if (!clusterId) {
                alert('Please enter a Cluster ID.');
                return;
            }
            fetchAndRender(`/api/cluster/dump-secrets-configmaps?clusterId=${clusterId}`, 'dump-table', ['appName', 'envName', 'configMap', 'secret']);
        }


        // SQL Query Interface Logic
        const queryInput = document.getElementById('query-input');
        const executeQueryBtn = document.getElementById('execute-query-btn');
        const queryResultsTable = document.querySelector('#query-results-table');

        async function executeQuery() {
            const query = queryInput.value;
            if (!query) {
                alert('Query cannot be empty.');
                return;
            }

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    body: query
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const results = await response.json();
                renderQueryResults(results);
            } catch (error) {
                console.error('Failed to execute query:', error);
                alert('Failed to execute query. See console for details.');
            }
        }

        function renderQueryResults(results) {
            const tableHead = queryResultsTable.querySelector('thead');
            const tableBody = queryResultsTable.querySelector('tbody');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (!results || results.length === 0) {
                tableBody.innerHTML = '<tr><td>No results found.</td></tr>';
                return;
            }

            // Create header row
            const headers = Object.keys(results[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Create data rows
            results.forEach(result => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = result[header];
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }

        executeQueryBtn.addEventListener('click', executeQuery);

        // Initial data fetch for all tables
        fetchAndRender('/api/users', 'users-table', ['id', 'email', 'roles', 'team', 'isActive']);
        fetchAndRender('/api/deployments', 'deployments-table', ['id', 'appName', 'environmentName', 'status', 'startedOn', 'finishedOn', 'triggeredBy', 'image', 'workflowType', 'imageDigest']);
        fetchAndRender('/api/applications', 'applications-table', null, renderApplications);
        fetchAndRender('/api/audits', 'audits-table', ['id', 'userId', 'userEmail', 'clientIp', 'timestamp']);
        fetchAndRender('/api/audits/triggers', 'trigger-audits-table', ['triggeredBy', 'appName', 'pipeline', 'timestamp']);
        fetchAndRender('/api/applications/virtual-service-usage', 'virtual-service-usage-table', ['appId', 'appName']);
        fetchAndRender('/api/pipelines/no-image-scan', 'no-image-scan-table', ['id', 'appName', 'name']);

    </script>
</body>
</html>
